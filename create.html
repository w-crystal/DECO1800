<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Create Event â€” Harmony</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <aside class="sidebar">
    <div class="logo">
      <span class="material-icons">album</span>
      <span class="logo-text">Harmony</span>
    </div>
    <a href="create.html" class="nav-item create-event-btn">
      <span class="material-icons">add_circle_outline</span>
      <span class="nav-text">Create Event</span>
    </a>
    <a href="index.html" class="nav-item">
      <span class="material-icons">home</span>
      <span class="nav-text">Home</span>
    </a>
    <a href="#" class="nav-item">
      <span class="material-icons">email</span>
      <span class="nav-text">Blog</span>
    </a>
    <a href="#" class="nav-item">
      <span class="material-icons">event</span>
      <span class="nav-text">Upcoming Events</span>
    </a>
    <a href="#" class="nav-item">
      <span class="material-icons">person</span>
      <span class="nav-text">My Profile</span>
    </a>
  </aside>

  <header class="header">
    <div class="search-bar">
      <input type="text" placeholder="Search">
    </div>
  </header>

  <main class="main-container">
    <div class="wizard-container">
      <h2>Create a New Event</h2>

      <!-- Progress Bar -->
      <div class="wizard-progress">
        <div class="progress-step active" data-step="1">1</div>
        <div class="progress-step" data-step="2">2</div>
        <div class="progress-step" data-step="3">3</div>
        <div class="progress-step" data-step="4">4</div>
        <div class="progress-step" data-step="5">5</div>
        <div class="progress-step" data-step="6">6</div>
      </div>

      <form id="createEventForm" novalidate>
        <!-- Step 1: Event Details -->
        <div id="step-1" class="wizard-step active">
          <h4>Step 1: Core Details</h4>
          <div class="modal-body">
            <label class="field">
              <span>Event Name (Required)</span>
              <input type="text" name="title" placeholder="e.g. Campus Jazz Night" required>
            </label>
             <label class="field">
                <span>Activity Type (Required)</span>
                <select name="activityType" required>
                    <option value="">Select an activity type...</option>
                    <option value="Live Show">Live Show</option>
                    <option value="Workshop">Workshop</option>
                    <option value="Community Meetup">Community Meetup</option>
                    <option value="Open Mic">Open Mic</option>
                </select>
            </label>
            <label class="field">
              <span>Genre (Required)</span>
              <select name="genre" required>
                <option value="">Select a genre...</option>
                <option value="Rock">Rock</option>
                <option value="Pop">Pop</option>
                <option value="Jazz">Jazz</option>
                <option value="Classical">Classical</option>
                <option value="Hip-Hop">Hip-Hop</option>
                <option value="EDM">EDM</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Step 2: Date & Time -->
        <div id="step-2" class="wizard-step">
          <h4>Step 2: Scheduling</h4>
          <div class="modal-body">
            <label class="field">
              <span>Date (Required)</span>
              <input type="date" name="date" required>
            </label>
            <label class="field">
              <span>Start Time (Required)</span>
              <input type="time" name="time" required>
            </label>
            <label class="field">
                <span>Duration (Required)</span>
                <input type="text" name="duration" placeholder="e.g., 2 hours" required>
            </label>
          </div>
        </div>
        
        <!-- Step 3: Location -->
        <div id="step-3" class="wizard-step">
            <h4>Step 3: Location</h4>
            <div class="modal-body">
                <label class="field">
                    <span>Location / Venue (Required)</span>
                    <input type="text" name="location" placeholder="e.g., Brisbane City Hall" required>
                </label>
                <div id="map"></div>
            </div>
        </div>

        <!-- Step 4: Optional Details -->
        <div id="step-4" class="wizard-step">
          <h4>Step 4: Additional Details</h4>
          <div class="modal-body">
            <div class="field">
                <label class="checkbox-label">
                    <input type="checkbox" id="ticketRequiredCheck"> Ticket Required
                </label>
                <div id="costField" style="display: none; margin-top: 10px;">
                    <span>Ticket Cost</span>
                    <input type="text" name="cost" placeholder="e.g., $15 or 'Free with booking'">
                </div>
            </div>
            <label class="field">
                <span>Age Range</span>
                <select name="ageRange">
                    <option value="All Ages">All Ages</option>
                    <option value="Kids">Kids</option>
                    <option value="Teens (13+)">Teens (13+)</option>
                    <option value="Adults (18+)">Adults (18+)</option>
                    <option value="Seniors (60+)">Seniors (60+)</option>
                </select>
            </label>
            <label class="field">
              <span>Event Image</span>
              <input type="file" name="image" accept="image/*">
            </label>
             <div class="field">
                <span>Tags</span>
                <div class="tag-selection">
                    <label><input type="checkbox" name="tags" value="Recruiting"> Recruiting</label>
                    <label><input type="checkbox" name="tags" value="Community"> Community</label>
                    <label><input type="checkbox" name="tags" value="Showcase"> Performance Showcase</label>
                    <label><input type="checkbox" name="tags" value="Concert"> Concert</label>
                    <label><input type="checkbox" name="tags" value="Fundraiser"> Fundraiser</label>
                    <label><input type="checkbox" name="tags" value="Family Friendly"> Family Friendly</label>
                    <label><input type="checkbox" name="tags" value="Limited Seats"> Limited Seats</label>
                </div>
            </div>
          </div>
        </div>

        <!-- Step 5: Description -->
        <div id="step-5" class="wizard-step">
            <h4>Step 5: Event Description</h4>
            <div class="modal-body">
                <label class="field">
                    <span>Description</span>
                    <textarea name="description" rows="6" placeholder="Tell everyone about your event..."></textarea>
                </label>
            </div>
        </div>

        <!-- Step 6: Summary -->
        <div id="step-6" class="wizard-step">
            <h4>Step 6: Review & Submit</h4>
            <div id="summary-review" class="summary-review">
                <!-- Summary content will be injected here by JS -->
            </div>
            <div class="field terms-field">
                <label class="checkbox-label">
                    <input type="checkbox" id="termsAndConditions" required> I agree to the <a href="#" target="_blank">Terms and Conditions</a>
                </label>
            </div>
        </div>

        <!-- Navigation -->
        <div class="wizard-navigation">
          <button type="button" id="prevBtn" class="btn ghost">Previous</button>
          <button type="button" id="nextBtn" class="btn primary">Next</button>
          <button type="submit" id="submitBtn" class="btn primary" style="display: none;" disabled>Create Event</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      const form = document.getElementById('createEventForm');
      const steps = Array.from(document.querySelectorAll('.wizard-step'));
      const progressSteps = Array.from(document.querySelectorAll('.progress-step'));
      const ticketCheck = document.getElementById('ticketRequiredCheck');
      const costField = document.getElementById('costField');
      const termsCheck = document.getElementById('termsAndConditions');

      var map = L.map('map').setView([51.505, -0.09], 13);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      var marker = L.marker([51.5, -0.09]).addTo(map);

      const API_URL = 'api/explore/v2.1/catalog/datasets/music-events/records?select=location%2Cstart_datetime%2Cend_datetime%2Cage%2Cevent_type%2Cdescription&limit=50](https://data.brisbane.qld.gov.au/api/explore/v2.1/catalog/datasets/music-events/records?select=location%2Cstart_datetime%2Cend_datetime%2Cage%2Cevent_type%2Cdescription&limit=50';
      
      function getLatLng(loc) {
        if (!loc) return null;
        if (typeof loc.lat === 'number' && typeof loc.lon === 'number') return [loc.lat, loc.lon];
        if (Array.isArray(loc.coordinates) && loc.coordinates.length >= 2) return [loc.coordinates[1], loc.coordinates[0]];
        if (loc.geometry && Array.isArray(loc.geometry.coordinates) && loc.geometry.coordinates.length >= 2)
          return [loc.geometry.coordinates[1], loc.geometry.coordinates[0]];
        return null;
      }
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          const results = data.results || [];
          const group = L.featureGroup().addTo(map);

          results.forEach(ev => {
            const latlng = getLatLng(ev.location);
            if (!latlng) return;

            const types = Array.isArray(ev.event_type) ? ev.event_type : (ev.event_type ? [ev.event_type] : []);
            const popup = `
              <b>${ev.location?.label || 'Event'}</b><br/>
              <b>Start:</b> ${ev.start_datetime || '-'}<br/>
              <b>End:</b> ${ev.end_datetime || '-'}<br/>
              <b>Type:</b> ${types.join(', ') || '-'}<br/>
              <b>Age:</b> ${ev.agerange || '-'}<br/>
              <p>${(ev.description || '').slice(0, 150)}...</p>
            `;
            L.marker(latlng).addTo(group).bindPopup(popup);
          });

          if (group.getLayers().length > 0) {
            map.fitBounds(group.getBounds().pad(0.2));
          }
        })
        .catch(err => console.error('Error loading data:', err));


      let currentStep = 1;
      const LS_KEY = 'harmony_events_v1';

      function showStep(stepNumber) {
        steps.forEach(step => step.classList.remove('active'));
        document.querySelector(`#step-${stepNumber}`).classList.add('active');

        progressSteps.forEach((step, index) => {
            if (index < stepNumber - 1) {
                step.classList.add('completed');
                step.classList.remove('active');
            } else if (index === stepNumber - 1) {
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                step.classList.remove('active', 'completed');
            }
        });

        prevBtn.style.display = stepNumber === 1 ? 'none' : 'inline-block';
        nextBtn.style.display = stepNumber === steps.length ? 'none' : 'inline-block';
        submitBtn.style.display = stepNumber === steps.length ? 'inline-block' : 'none';
      }
  <!-- 
    function validateStep(stepNumber) {
          const currentStepFields = steps[stepNumber - 1].querySelectorAll('[required]:not(:disabled)');
          for (const field of currentStepFields) {
              if (!field.value.trim() && field.type !== 'checkbox' || (field.type === 'checkbox' && !field.checked)) {
                  const fieldLabel = field.closest('.field').querySelector('span');
                  const fieldName = fieldLabel ? fieldLabel.textContent : 'the required field';
                  alert(`Please fill out ${fieldName}.`);
                  field.focus();
                  return false;
              }
          }
          return true;
      } 

  -->
       
      function populateSummary() {
          const formData = new FormData(form);
          const summaryContainer = document.getElementById('summary-review');
          let summaryHTML = '<ul>';
          summaryHTML += `<li><strong>Name:</strong> ${formData.get('title') || 'Not provided'}</li>`;
          summaryHTML += `<li><strong>Activity:</strong> ${formData.get('activityType') || 'Not provided'}</li>`;
          summaryHTML += `<li><strong>Genre:</strong> ${formData.get('genre') || 'Not provided'}</li>`;
          summaryHTML += `<li><strong>Date & Time:</strong> ${formData.get('date')} at ${formData.get('time')}</li>`;
          summaryHTML += `<li><strong>Duration:</strong> ${formData.get('duration') || 'Not provided'}</li>`;
          summaryHTML += `<li><strong>Location:</strong> ${formData.get('location') || 'Not provided'}</li>`;
          summaryHTML += `<li><strong>Description:</strong> ${formData.get('description') || 'Not provided'}</li>`;

          if (ticketCheck.checked) {
              summaryHTML += `<li><strong>Cost:</strong> ${formData.get('cost') || 'To be confirmed'}</li>`;
          } else {
              summaryHTML += `<li><strong>Cost:</strong> Free</li>`;
          }
          
          summaryHTML += `<li><strong>Age Range:</strong> ${formData.get('ageRange')}</li>`;
          const tags = formData.getAll('tags');
          if (tags.length > 0) summaryHTML += `<li><strong>Tags:</strong> ${tags.join(', ')}</li>`;

          summaryHTML += '</ul>';
          summaryContainer.innerHTML = summaryHTML;
      }

      nextBtn.addEventListener('click', () => {
        if (validateStep(currentStep)) {
            if (currentStep < steps.length) {
                currentStep++;
                if (currentStep === steps.length) {
                    populateSummary();
                }
                showStep(currentStep);
            }
        }
      });

      prevBtn.addEventListener('click', () => {
        if (currentStep > 1) {
          currentStep--;
          showStep(currentStep);
        }
      });

      // Show/hide cost field based on ticket checkbox
      ticketCheck.addEventListener('change', () => {
          costField.style.display = ticketCheck.checked ? 'block' : 'none';
      });

      // Enable/disable submit button based on T&C checkbox
      termsCheck.addEventListener('change', () => {
          submitBtn.disabled = !termsCheck.checked;
      });
      
      // --- LocalStorage and Submission Logic ---
      function trimStr(v){return typeof v==='string'?v.trim():'';}

      function loadEvents() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) { return []; }
      }

      function saveEvents(events) {
        try { localStorage.setItem(LS_KEY, JSON.stringify(events)); } catch (e) {}
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        if (!termsCheck.checked) {
            alert('You must agree to the Terms and Conditions to create an event.');
            return;
        }

        const fd = new FormData(form);
        const date = trimStr(fd.get('date'));
        const time = trimStr(fd.get('time'));
        
        const dateTimeString = `${date}T${time}`;
        const dtLocal = new Date(dateTimeString);

        const tags = fd.getAll('tags');
        if (fd.get('genre')) tags.unshift(fd.get('genre'));

        const payload = {
          title: trimStr(fd.get('title')),  
          tag: tags.join(', '),
          image: trimStr(fd.get('image')), // Note: file upload won't be saved to localStorage this way
          location: trimStr(fd.get('location')),
          timeISO: !isNaN(dtLocal.getTime()) ? dtLocal.toISOString() : null,
          description: trimStr(fd.get('description'))
        };
        
        const current = loadEvents();
        current.unshift(payload);
        saveEvents(current);
        alert('Event Created Successfully!');
        window.location.href = 'index.html';
      });

      showStep(currentStep); // Initialize the first step
    });
  </script>
</body>
</html>
