<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="new.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <title>Harmony</title>
</head>
<body>
      <!-- The sidebar will be loaded into this placeholder -->
      <div id="sidebar-placeholder"></div>

    <div class="main-container">
        <div class="search-page-container">
            <!-- Search Header with Bar and Tags -->
            <div class="search-header">
                <h1 class="text-color-v2">Find a Music Event</h1>
                <form class="search-bar-main">
                    <span class="material-icons">search</span>
                    <input id="filter-text" type="text" placeholder="Search by name, date, or location...">
                </form>

                <div class="search-tags">
                    <button class="tag-filter active">All</button>
                    <button class="tag-filter">Recruiting</button>
                    <button class="tag-filter">Live Show</button>
                    <button class="tag-filter">Community</button>
                    <button class="tag-filter">Fundraiser</button>
                </div>
            </div>
        </div>
        <section id="records"></section>
        <div class="expand-content"></div>
    </div>
</body>

<script>
    function iterateRecords(data) {
        console.log("Data returned: " + JSON.stringify(data));
        var records = data.results;
        Object.values(records).forEach(value => {
            var subject = value["subject"];
            var venue = value["venue"];
            var formatteddatetime = value["formatteddatetime"];
            var description = value["description"];
            var event_type = value["event_type"];
            var bookings = value["bookings"];

            if(subject && venue && formatteddatetime && description && event_type ){
                    const expanded = $('<div class="expanded-con">').append(
                        $('<p>').text("Time: " + formatteddatetime),
                        $('<p>').text("Description: " + description),
                        $('<p>').text("Location: " + venue),
                        $('<p>').text("Event type: " + event_type)
                    );
                
                    const card = $('<section class="record">').append(
                        $('<h3>').text(subject),
                        $('<p>').text("üìÖ " + formatteddatetime),
                        $('<p>').text("üìç " + venue),

                    );

                    card.data('record', {
                        subject, venue, formatteddatetime, description, event_type, bookings
                    });
                    $("#records").append(card);
            }
        });
    }

    $(document).on('click', '.record', function() {
        const data = $(this).data('record'); // grab stored record

        const details = `
            <div class="drawer">
                <button class="drawer-close">√ó</button>
                <h2>${data.subject}</h2>
                <p><strong>Start time:</strong> ${data.formatteddatetime}</p>
                <p><strong>Venue:</strong> ${data.venue}</p>
                <p><strong>Description:</strong> ${data.description}</p>
                <p><strong>Event type:</strong> ${data.event_type}</p>
                <p><strong>Bookings:</strong> ${data.bookings}</p>
            </div>
        `;
        $('.expand-content').html(details).addClass('open');
    });

        // close drawer
    $(document).on('click', '.drawer-close', function() {
        $('.expand-content').removeClass('open').empty();
    });

    $(document).ready(function() {
        const LS_KEY = 'harmony_events_v1';
        const HIGHTLIGHT_KEY = 'justCreatedKey';

        try{
            const raw = localStorage.getItem(LS_KEY);
            const locals = raw ? JSON.parse(raw) : [];
            if (locals.length) {
                iterateRecords({results: locals});

                const key = localStorage.getItem(HIGHTLIGHT_KEY);
                if (key) {
                    const [s, t] = key.split('@@');
                    $('record').each(function() {
                        const txt = $(this).text();
                        if (txt.includes(s) && txt.includes(t)) {
                            $(this).addClass('newly-created');
                        }
                    });
                    localStorage.removeItem(HIGHTLIGHT_KEY);
                }
            }
        }catch(e){
            console.error("Error reading localStorage:", e);
        }

        var data ={};
        const apiURL = "https://data.brisbane.qld.gov.au/api/explore/v2.1/catalog/datasets/music-events/records";

        const requestParams = {
            select : "subject,venue,formatteddatetime,description,event_type,bookings",
            limit: 100
        };

        const queryString = new URLSearchParams(requestParams).toString();
        const fullURL = apiURL + '?' + queryString;
        console.log("URL: " + fullURL)

        fetch(fullURL)
            .then(response => response.json())
            .then(data => iterateRecords(data))
            .catch(error => console.error("Error fetching data:", error));

        // Live search filter for #filter-text
        $(document).on('keyup', '#filter-text', function() {
            var searchTerm = $(this).val().toLowerCase();
            $(".record").each(function() {
                var text = $(this).text().toLowerCase();
                $(this).toggle(text.indexOf(searchTerm) > -1);
            });
        });
    });

        // Basic interactivity for the tags
        document.addEventListener('DOMContentLoaded', function () {
            const tagFilters = document.querySelectorAll('.tag-filter');

            tagFilters.forEach(button => {
                button.addEventListener('click', function () {

                    tagFilters.forEach(btn => btn.classList.remove('active'));
                    

                    this.classList.add('active');


                    console.log(`Filtering by: ${this.textContent}`);
                });
            });
        });

         // This script fetches and inserts the sidebar

  document.addEventListener("DOMContentLoaded", function() {
    const sidebarPlaceholder = document.getElementById('sidebar-placeholder');

    fetch('sidebar.html')
        .then(response => response.text())
        .then(data => {
            sidebarPlaceholder.innerHTML = data;

            sidebarPlaceholder.addEventListener('mouseenter', () => {
                document.body.classList.add('sidebar-expanded');
            });
            sidebarPlaceholder.addEventListener('mouseleave', () => {
                document.body.classList.remove('sidebar-expanded');
            });

            const currentPage = window.location.pathname.split("/").pop();
            const navLinks = sidebarPlaceholder.querySelectorAll('.nav-item');
            navLinks.forEach(link => {
                const linkPage = link.getAttribute('href');
                if (linkPage === currentPage) {
                    link.classList.add('active');
                }
            });
        })
        .catch(error => {
            console.error('Error fetching the sidebar:', error);
            sidebarPlaceholder.innerHTML = '<p style="color:red; padding:20px;">Error loading navigation.</p>';
        });
});
</script>

